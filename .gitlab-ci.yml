stages:
  - upload
  - deploy

.upload_consul:
  image: git.noxcrew.online:5050/noxcrew/devops/fs2consulkv:master-70dae7e08fda29b866eb58635b62ae6b5efe77e8
  # https://gitlab.com/gitlab-org/gitlab-runner/-/issues/27524
  script: 
    - kubectl --namespace ops port-forward service/consul-server 8500:8500 &
    - sleep 5
    - fs2consulkv --fs-kv-path . --consul-url http://localhost:8500 --consul-acl-token "$CONSUL_ACL_TOKEN" --consul-kv-root "configuration/$CI_COMMIT_BRANCH" --skip-prompt
    - kill $!
    
.kube_env_dev:
  extends: .upload_consul
  environment:
    name: dev-fs2consulkv
    kubernetes:
      namespace: ops

.kube_env_ptr:
  extends: .upload_consul
  environment:
    name: ptr-fs2consulkv
    kubernetes:
      namespace: ops

upload_consul_dev:
  stage: upload
  extends: [ .kube_env_dev, .upload_consul ]

upload_consul_ptr:
  stage: upload
  extends: [ .kube_env_ptr, .upload_consul ]
